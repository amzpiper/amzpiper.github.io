<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å…³é”®å­—-volatile | ç§äººçŸ¥è¯†å›¾ä¹¦é¦†</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="åŒ…å«: Java åŸºç¡€, Java éƒ¨åˆ†æºç , JVM, Spring, Spring Boot, Spring Cloud, æ•°æ®åº“åŸç†, MySQL, ElasticSearch, MongoDB, Docker, k8s, CI&amp;CD, Linux, DevOps, åˆ†å¸ƒå¼, ä¸­é—´ä»¶, å¼€å‘å·¥å…·, Git, IDE, æºç é˜…è¯»ï¼Œè¯»ä¹¦ç¬”è®°, å¼€æºé¡¹ç›®...">
    <meta name="robots" content="all">
    <meta name="author" content="pdai">
    <meta name="keywords" content="ç§äººçŸ¥è¯†å›¾ä¹¦é¦†, javaä½“ç³», javaçŸ¥è¯†ä½“ç³», javaæ¡†æ¶,javaè¯¦è§£,javaå­¦ä¹ è·¯çº¿,java spring, javaé¢è¯•, çŸ¥è¯†ä½“ç³», javaæŠ€æœ¯ä½“ç³», javaç¼–ç¨‹, javaç¼–ç¨‹æŒ‡å—,javaå¼€å‘ä½“ç³», javaå¼€å‘,javaæ•™ç¨‹,java,javaæ•°æ®ç»“æ„, ç®—æ³•, å¼€å‘åŸºç¡€">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.cb877f3d.css" as="style"><link rel="preload" href="/assets/js/app.c015e375.js" as="script"><link rel="preload" href="/assets/js/5.ea3a467f.js" as="script"><link rel="preload" href="/assets/js/31.b0e9667f.js" as="script"><link rel="prefetch" href="/assets/js/10.97090540.js"><link rel="prefetch" href="/assets/js/11.3f596b90.js"><link rel="prefetch" href="/assets/js/12.2b9fddc3.js"><link rel="prefetch" href="/assets/js/13.d6271850.js"><link rel="prefetch" href="/assets/js/14.85b42e44.js"><link rel="prefetch" href="/assets/js/15.9c9ef26c.js"><link rel="prefetch" href="/assets/js/16.de77b749.js"><link rel="prefetch" href="/assets/js/17.1a28fe64.js"><link rel="prefetch" href="/assets/js/18.65db727f.js"><link rel="prefetch" href="/assets/js/19.f0cab2cf.js"><link rel="prefetch" href="/assets/js/2.2c55f875.js"><link rel="prefetch" href="/assets/js/20.bc2a1ebe.js"><link rel="prefetch" href="/assets/js/21.9d44366f.js"><link rel="prefetch" href="/assets/js/22.8d7f32d4.js"><link rel="prefetch" href="/assets/js/23.302f98ca.js"><link rel="prefetch" href="/assets/js/24.cebfc8b6.js"><link rel="prefetch" href="/assets/js/25.32e88dc5.js"><link rel="prefetch" href="/assets/js/26.d6cf3bce.js"><link rel="prefetch" href="/assets/js/27.a97d8205.js"><link rel="prefetch" href="/assets/js/28.ae33a8cf.js"><link rel="prefetch" href="/assets/js/29.79c71861.js"><link rel="prefetch" href="/assets/js/3.97962a42.js"><link rel="prefetch" href="/assets/js/30.90aec520.js"><link rel="prefetch" href="/assets/js/32.1a06a235.js"><link rel="prefetch" href="/assets/js/33.90c0c365.js"><link rel="prefetch" href="/assets/js/4.1fed06c3.js"><link rel="prefetch" href="/assets/js/6.4c970dc8.js"><link rel="prefetch" href="/assets/js/7.702fcf9c.js"><link rel="prefetch" href="/assets/js/8.15f570fb.js"><link rel="prefetch" href="/assets/js/9.b774803a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cb877f3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="ç§äººçŸ¥è¯†å›¾ä¹¦é¦†" class="logo"> <span class="site-name can-hide">ç§äººçŸ¥è¯†å›¾ä¹¦é¦†</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  æ¦‚è¿°
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/learn-typescript.html" class="nav-link">
  Typescript
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/ChromeExtensions.html" class="nav-link">
  ChromeExtensions
</a></li></ul></li><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Stream.html" class="nav-link">
  Stream
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Optional.html" class="nav-link">
  Optional
</a></li></ul></li><li class="dropdown-item"><h4>
          Javaé«˜å¹¶å‘
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="nav-link">
  Javaçº¿ç¨‹æ± 
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="nav-link">
  é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-ç†è®ºåŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="nav-link">
  å…³é”®å­—-synchronized
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="nav-link">
  å…³é”®å­—-volatile
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-final.html" class="nav-link">
  å…³é”®å­—-final
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="nav-link">
  é«˜å¹¶å‘-ThreadLocalè¯¦è§£
</a></li></ul></li><li class="dropdown-item"><h4>
          æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  Springç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="nav-link">
  SpringMVCç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Mybatisç¬”è®°.html" class="nav-link">
  Mybatisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="nav-link">
  MybatisPlusç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  SpringBootç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Dubboç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-zookeeper.html" class="nav-link">
  Zookeeperç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-redis.html" class="nav-link">
  Redisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-elasticstack.html" class="nav-link">
  Elasticstackç¬”è®°
</a></li></ul></li><li class="dropdown-item"><h4>
          JVM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="nav-link">
  JVMå¿«é€Ÿå…¥é—¨ç¯‡
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–¹æ³•è®º" class="dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–¹æ³•è®º" class="mobile-dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/method/è®¾è®¡æ¨¡å¼.html" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="mobile-dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/tool/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/md/java/tool/Mavenå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Maven
</a></li></ul></div></div><div class="nav-item"><a href="/md/about/about-me.html" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/amzpiper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  æ¦‚è¿°
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/learn-typescript.html" class="nav-link">
  Typescript
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/ChromeExtensions.html" class="nav-link">
  ChromeExtensions
</a></li></ul></li><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Stream.html" class="nav-link">
  Stream
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Optional.html" class="nav-link">
  Optional
</a></li></ul></li><li class="dropdown-item"><h4>
          Javaé«˜å¹¶å‘
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="nav-link">
  Javaçº¿ç¨‹æ± 
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="nav-link">
  é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-ç†è®ºåŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="nav-link">
  å…³é”®å­—-synchronized
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="nav-link">
  å…³é”®å­—-volatile
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-final.html" class="nav-link">
  å…³é”®å­—-final
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="nav-link">
  é«˜å¹¶å‘-ThreadLocalè¯¦è§£
</a></li></ul></li><li class="dropdown-item"><h4>
          æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  Springç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="nav-link">
  SpringMVCç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Mybatisç¬”è®°.html" class="nav-link">
  Mybatisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="nav-link">
  MybatisPlusç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  SpringBootç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Dubboç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-zookeeper.html" class="nav-link">
  Zookeeperç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-redis.html" class="nav-link">
  Redisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-elasticstack.html" class="nav-link">
  Elasticstackç¬”è®°
</a></li></ul></li><li class="dropdown-item"><h4>
          JVM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="nav-link">
  JVMå¿«é€Ÿå…¥é—¨ç¯‡
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–¹æ³•è®º" class="dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–¹æ³•è®º" class="mobile-dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/method/è®¾è®¡æ¨¡å¼.html" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="mobile-dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/tool/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/md/java/tool/Mavenå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Maven
</a></li></ul></div></div><div class="nav-item"><a href="/md/about/about-me.html" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/amzpiper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å‰ç«¯</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/learn-typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/md/java/learn/ChromeExtensions.html" class="sidebar-link">Chrome Extensions</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Java8-Stream.html" class="sidebar-link">Java 8 - Stream</a></li><li><a href="/md/java/learn/Java8-Optional.html" class="sidebar-link">Java 8 - Optional</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Javaé«˜å¹¶å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="sidebar-link">Java çº¿ç¨‹æ± </a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="sidebar-link">é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="sidebar-link">é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="sidebar-link">é«˜å¹¶å‘-ç†è®ºåŸºç¡€</a></li><li><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="sidebar-link">å…³é”®å­—-synchronized</a></li><li><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="active sidebar-link">å…³é”®å­—-volatile</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile" class="sidebar-link">å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#volatileçš„ä½œç”¨è¯¦è§£" class="sidebar-link">volatileçš„ä½œç”¨è¯¦è§£</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#é˜²é‡æ’åº" class="sidebar-link">é˜²é‡æ’åº</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#å®ç°å¯è§æ€§" class="sidebar-link">å®ç°å¯è§æ€§</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" class="sidebar-link">ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™</a></li></ul></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#volatile-çš„å®ç°åŸç†" class="sidebar-link">volatile çš„å®ç°åŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#volatile-å¯è§æ€§å®ç°" class="sidebar-link">volatile å¯è§æ€§å®ç°</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#volatile-æœ‰åºæ€§å®ç°" class="sidebar-link">volatile æœ‰åºæ€§å®ç°</a></li></ul></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#volatile-çš„åº”ç”¨åœºæ™¯" class="sidebar-link">volatile çš„åº”ç”¨åœºæ™¯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" class="sidebar-link">æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication-no-mean" class="sidebar-link">æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)-no mean</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" class="sidebar-link">æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼4-volatile-bean-æ¨¡å¼" class="sidebar-link">æ¨¡å¼4ï¼švolatile bean æ¨¡å¼</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" class="sidebar-link">æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/å…³é”®å­—-volatile.html#æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" class="sidebar-link">æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked)</a></li></ul></li></ul></li><li><a href="/md/java/learn/å…³é”®å­—-final.html" class="sidebar-link">å…³é”®å­—-final</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="sidebar-link">é«˜å¹¶å‘ - ThreadLocalè¯¦è§£</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æ¡†æ¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Springç¬”è®°.html" class="sidebar-link">Spring</a></li><li><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="sidebar-link">SpringMVC</a></li><li><a href="/md/java/learn/Mybatisç¬”è®°.html" class="sidebar-link">Mybatis</a></li><li><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="sidebar-link">Mybatis-Plus</a></li><li><a href="/md/java/learn/SpringBootç¬”è®°.html" class="sidebar-link">SpringBoot</a></li><li><a href="/md/java/learn/learn-zookeeper.html" class="sidebar-link">Zookeeper</a></li><li><a href="/md/java/learn/learn-redis.html" class="sidebar-link">Redis</a></li><li><a href="/md/java/learn/learn-elasticstack.html" class="sidebar-link">Elasticstack</a></li><li><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="sidebar-link">Dubbo</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="sidebar-link">JVMå¿«é€Ÿå…¥é—¨ç¯‡</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="å…³é”®å­—-volatile"><a href="#å…³é”®å­—-volatile" class="header-anchor">#</a> å…³é”®å­—-volatile</h1> <aside>
ğŸ’¡ ç›¸æ¯”Sychronized(é‡é‡çº§é”ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§)ï¼Œvolatileæä¾›äº†å¦ä¸€ç§è§£å†³å¯è§æ€§å’Œæœ‰åºæ€§é—®é¢˜çš„æ–¹æ¡ˆã€‚
</aside> <h2 id="å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile"><a href="#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile" class="header-anchor">#</a> å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£volatile</h2> <aside>
ğŸ’¡ è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£volatileã€‚
</aside> <ul><li>volatile<strong>å…³é”®å­—çš„ä½œç”¨</strong>æ˜¯ä»€ä¹ˆ?</li> <li>volatile<strong>èƒ½å¦ä¿è¯åŸå­æ€§</strong>?</li> <li><strong>ä¹‹å‰</strong>32ä½æœºå™¨ä¸Šå…±äº«çš„longå’Œdoubleå˜é‡çš„<strong>ä¸ºä»€ä¹ˆè¦ç”¨volatile</strong>? ç°åœ¨64ä½æœºå™¨ä¸Šæ˜¯å¦ä¹Ÿè¦è®¾ç½®å‘¢?</li> <li><strong>i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§</strong>?</li> <li>volatileæ˜¯<strong>å¦‚ä½•å®ç°å¯è§æ€§</strong>çš„? å†…å­˜å±éšœã€‚</li> <li>volatileæ˜¯<strong>å¦‚ä½•å®ç°æœ‰åºæ€§</strong>çš„? happens-beforeç­‰</li> <li>è¯´ä¸‹volatileçš„<strong>åº”ç”¨åœºæ™¯</strong>?</li></ul> <h2 id="volatileçš„ä½œç”¨è¯¦è§£"><a href="#volatileçš„ä½œç”¨è¯¦è§£" class="header-anchor">#</a> volatileçš„ä½œç”¨è¯¦è§£</h2> <h3 id="é˜²é‡æ’åº"><a href="#é˜²é‡æ’åº" class="header-anchor">#</a> é˜²é‡æ’åº</h3> <p>æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç»å…¸çš„ä¾‹å­æ¥åˆ†æé‡æ’åºé—®é¢˜ã€‚å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œè€Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å•ä¾‹å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é‡‡ç”¨åŒé‡æ£€æŸ¥åŠ é”(DCL)çš„æ–¹å¼æ¥å®ç°ã€‚å…¶æºç å¦‚ä¸‹ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class Singleton {
    public static volatile Singleton singleton;
    /**
     * æ„é€ å‡½æ•°ç§æœ‰ï¼Œç¦æ­¢å¤–éƒ¨å®ä¾‹åŒ–
     */
    private Singleton() {};
    public static Singleton getInstance() {
        if (singleton == null) {
            synchronized (singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>ç°åœ¨æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨å˜é‡singletonä¹‹é—´åŠ ä¸Švolatileå…³é”®å­—ã€‚è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå…ˆè¦äº†è§£å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å…¶å®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p> <ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li> <li>åˆå§‹åŒ–å¯¹è±¡ã€‚</li> <li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li></ul> <p>ä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå¯ä»¥<code>å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº</code>ï¼Œæ‰€ä»¥ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šå˜æˆå¦‚ä¸‹è¿‡ç¨‹ï¼š</p> <ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li> <li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li> <li>åˆå§‹åŒ–å¯¹è±¡</li></ul> <p>å¦‚æœæ˜¯è¿™ä¸ªæµç¨‹ï¼Œ<strong>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯èƒ½å°†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨æš´éœ²å‡ºæ¥</strong>ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æ–™çš„ç»“æœã€‚å› æ­¤ï¼Œ<strong>ä¸ºäº†é˜²æ­¢è¿™ä¸ªè¿‡ç¨‹çš„é‡æ’åº</strong>ï¼Œæˆ‘ä»¬éœ€è¦<strong>å°†å˜é‡è®¾ç½®ä¸ºvolatileç±»å‹</strong>çš„å˜é‡ã€‚</p> <h3 id="å®ç°å¯è§æ€§"><a href="#å®ç°å¯è§æ€§" class="header-anchor">#</a> å®ç°å¯è§æ€§</h3> <p>å¯è§æ€§é—®é¢˜ä¸»è¦æŒ‡ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡å€¼ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å´çœ‹ä¸åˆ°ã€‚å¼•èµ·å¯è§æ€§é—®é¢˜çš„ä¸»è¦åŸå› æ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€ä¸ªé«˜é€Ÿç¼“å­˜åŒºâ€”â€”çº¿ç¨‹å·¥ä½œå†…å­˜ã€‚volatileå…³é”®å­—èƒ½æœ‰æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼Œå°±å¯ä»¥çŸ¥é“å…¶ä½œç”¨ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b=&quot;</span><span class="token operator">+</span>b<span class="token operator">+</span><span class="token string">&quot;;a=&quot;</span><span class="token operator">+</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">VolatileTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolatileTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">*</span><span class="token operator">*</span>test<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token operator">*</span><span class="token operator">*</span>test<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>ç›´è§‚ä¸Šè¯´ï¼Œè¿™æ®µä»£ç çš„ç»“æœåªå¯èƒ½æœ‰ä¸¤ç§ï¼šb=3;a=3 æˆ– b=2;a=1ã€‚ä¸è¿‡è¿è¡Œä¸Šé¢çš„ä»£ç (å¯èƒ½æ—¶é—´ä¸Šè¦é•¿ä¸€ç‚¹)ï¼Œä½ ä¼šå‘ç°é™¤äº†ä¸Šä¸¤ç§ç»“æœä¹‹å¤–ï¼Œè¿˜å‡ºç°äº†ç¬¬ä¸‰ç§ç»“æœï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>......
b=2;a=1
b=2;a=1
b=3;a=3
b=3;a=3
**b=3;a=1 // è¿™é‡Œ**
b=3;a=3
b=2;a=1
b=3;a=3
b=3;a=3
......
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°b=3;a=1è¿™ç§ç»“æœå‘¢?</p> <p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå…ˆæ‰§è¡Œchangeæ–¹æ³•ï¼Œå†æ‰§è¡Œprintæ–¹æ³•ï¼Œè¾“å‡ºç»“æœåº”è¯¥ä¸ºb=3;a=3ã€‚ç›¸åï¼Œå¦‚æœå…ˆæ‰§è¡Œçš„printæ–¹æ³•ï¼Œå†æ‰§è¡Œchangeæ–¹æ³•ï¼Œç»“æœåº”è¯¥æ˜¯ b=2;a=1ã€‚é‚£b=3;a=1çš„ç»“æœæ˜¯æ€ä¹ˆå‡ºæ¥çš„?</p> <p><strong>åŸå› </strong>å°±æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹å°†å€¼a=3ä¿®æ”¹åï¼Œä½†æ˜¯å¯¹ç¬¬äºŒä¸ªçº¿ç¨‹æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥æ‰å‡ºç°è¿™ä¸€ç»“æœï¼Œæ‰€ä»¥æ‰å‡ºç°è¿™ä¸€ç»“æœã€‚å¦‚æœå°†aå’Œbéƒ½æ”¹æˆvolatileç±»å‹çš„å˜é‡å†æ‰§è¡Œï¼Œåˆ™å†ä¹Ÿä¸ä¼šå‡ºç°b=3;a=1çš„ç»“æœäº†ã€‚</p> <h3 id="ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™"><a href="#ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" class="header-anchor">#</a> ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™</h3> <p>volatile<strong>ä¸èƒ½ä¿è¯å®Œå…¨çš„åŸå­æ€§</strong>ï¼Œåªèƒ½<strong>ä¿è¯å•æ¬¡çš„è¯»/å†™æ“ä½œå…·æœ‰åŸå­æ€§</strong>ã€‚å…ˆä»å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜æ¥ç†è§£ï¼ˆåæ–‡å†ä»å†…å­˜å±éšœçš„è§’åº¦ç†è§£ï¼‰ï¼š</p> <p><strong>é—®é¢˜1ï¼š i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§?</strong></p> <p>å¯¹äºåŸå­æ€§ï¼Œéœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å¤§å®¶å®¹æ˜“è¯¯è§£çš„ä¸€ç‚¹ï¼šå¯¹volatileå˜é‡çš„å•æ¬¡è¯»/å†™æ“ä½œå¯ä»¥ä¿è¯åŸå­æ€§çš„ï¼Œå¦‚longå’Œdoubleç±»å‹å˜é‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯i++è¿™ç§æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸ºæœ¬è´¨ä¸Ši++æ˜¯è¯»ã€å†™ä¸¤æ¬¡æ“ä½œã€‚</p> <p>ç°åœ¨æˆ‘ä»¬å°±é€šè¿‡ä¸‹åˆ—ç¨‹åºæ¥æ¼”ç¤ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class VolatileTest01 {
    volatile int i;

    public void addI(){
        i++;
    }

    public static void main(String[] args) throws InterruptedException {
        final  VolatileTest01 test01 = new VolatileTest01();
        for (int n = 0; n &lt; 1000; n++) {
            new Thread(new Runnable() {
                @Override
                public void run() {
                    try {
                        Thread.sleep(10);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    test01.addI();
                }
            }).start();
        }
        Thread.sleep(10000);//ç­‰å¾…10ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ
        System.out.println(test01.i);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>å¤§å®¶å¯èƒ½ä¼šè¯¯è®¤ä¸ºå¯¹å˜é‡iåŠ ä¸Šå…³é”®å­—volatileåï¼Œè¿™æ®µç¨‹åºå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤§å®¶å¯ä»¥å°è¯•è¿è¡Œä¸Šé¢çš„ç¨‹åºã€‚ä¸‹é¢æ˜¯æˆ‘æœ¬åœ°è¿è¡Œçš„ç»“æœï¼š981
å¯èƒ½æ¯ä¸ªäººè¿è¡Œçš„ç»“æœä¸ç›¸åŒã€‚ä¸è¿‡åº”è¯¥èƒ½çœ‹å‡ºï¼Œvolatileæ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„(å¦åˆ™ç»“æœåº”è¯¥æ˜¯1000)ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œi++å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥éª¤ï¼š</p> <ul><li>è¯»å–içš„å€¼ã€‚</li> <li>å¯¹iåŠ 1ã€‚</li> <li>å°†içš„å€¼å†™å›å†…å­˜ã€‚</li></ul> <aside>
ğŸ’¡ volatileæ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AtomicIntegeræˆ–è€…Synchronizedæ¥ä¿è¯+1æ“ä½œçš„åŸå­æ€§ã€‚
æ³¨ï¼šä¸Šé¢å‡ æ®µä»£ç ä¸­å¤šå¤„æ‰§è¡Œäº†Thread.sleep()æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†å¢åŠ å¹¶å‘é—®é¢˜çš„äº§ç”Ÿå‡ ç‡ï¼Œæ— å…¶ä»–ä½œç”¨ã€‚
</aside> <p><strong>é—®é¢˜2ï¼š å…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile?</strong></p> <p>å› ä¸ºlongå’Œdoubleä¸¤ç§æ•°æ®ç±»å‹çš„æ“ä½œå¯åˆ†ä¸ºé«˜32ä½å’Œä½32ä½ä¸¤éƒ¨åˆ†ï¼Œå› æ­¤æ™®é€šçš„longæˆ–doubleç±»å‹è¯»/å†™å¯èƒ½ä¸æ˜¯åŸå­çš„ã€‚å› æ­¤ï¼Œé¼“åŠ±å¤§å®¶å°†å…±äº«çš„longå’Œdoubleå˜é‡è®¾ç½®ä¸ºvolatileç±»å‹ï¼Œè¿™æ ·èƒ½ä¿è¯ä»»ä½•æƒ…å†µä¸‹å¯¹longå’Œdoubleçš„å•æ¬¡è¯»/å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ã€‚</p> <p>å¦‚ä¸‹æ˜¯JLSä¸­çš„è§£é‡Šï¼š</p> <blockquote><p>17.7 Non-Atomic Treatment of double and long</p></blockquote> <ul><li>For the purposes of the Java programming language memory model, a single write to a non-volatile long or double value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write.</li> <li>Writes and reads of volatile long and double values are always atomic.</li> <li>Writes to and reads of references are always atomic, regardless of whether they are implemented as 32-bit or 64-bit values.</li> <li>Some implementations may find it convenient to divide a single write action on a 64-bit long or double value into two write actions on adjacent 32-bit values. For efficiencyâ€™s sake, this behavior is implementation-specific; an implementation of the Java Virtual Machine is free to perform writes to long and double values atomically or in two parts.</li> <li>Implementations of the Java Virtual Machine are encouraged to avoid splitting 64-bit values where possible. Programmers are encouraged to declare shared 64-bit values as volatile or synchronize their programs correctly to avoid possible complications.</li></ul> <p>ç›®å‰å„ç§å¹³å°ä¸‹çš„å•†ç”¨è™šæ‹Ÿæœºéƒ½é€‰æ‹©æŠŠ 64 ä½æ•°æ®çš„è¯»å†™æ“ä½œä½œä¸ºåŸå­æ“ä½œæ¥å¯¹å¾…ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸æŠŠlong å’Œ double å˜é‡ä¸“é—¨å£°æ˜ä¸º volatileå¤šæ•°æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸ä¼šé”™çš„ã€‚</p> <h2 id="volatile-çš„å®ç°åŸç†"><a href="#volatile-çš„å®ç°åŸç†" class="header-anchor">#</a> <strong>volatile çš„å®ç°åŸç†</strong></h2> <h3 id="volatile-å¯è§æ€§å®ç°"><a href="#volatile-å¯è§æ€§å®ç°" class="header-anchor">#</a> <strong>volatile å¯è§æ€§å®ç°</strong></h3> <h3 id="volatile-æœ‰åºæ€§å®ç°"><a href="#volatile-æœ‰åºæ€§å®ç°" class="header-anchor">#</a> <strong>volatile æœ‰åºæ€§å®ç°</strong></h3> <h2 id="volatile-çš„åº”ç”¨åœºæ™¯"><a href="#volatile-çš„åº”ç”¨åœºæ™¯" class="header-anchor">#</a> volatile çš„åº”ç”¨åœºæ™¯</h2> <p>ä½¿ç”¨ volatile å¿…é¡»å…·å¤‡çš„æ¡ä»¶</p> <ul><li>å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼ã€‚</li> <li>è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­ã€‚</li> <li>åªæœ‰åœ¨çŠ¶æ€çœŸæ­£ç‹¬ç«‹äºç¨‹åºå†…å…¶ä»–å†…å®¹æ—¶æ‰èƒ½ä½¿ç”¨ volatileã€‚</li></ul> <h3 id="æ¨¡å¼1-çŠ¶æ€æ ‡å¿—"><a href="#æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" class="header-anchor">#</a> æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—</h3> <p>ä¹Ÿè®¸å®ç° volatile å˜é‡çš„è§„èŒƒä½¿ç”¨ä»…ä»…æ˜¯ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†ä¸€ä¸ªé‡è¦çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¾‹å¦‚å®Œæˆåˆå§‹åŒ–æˆ–è¯·æ±‚åœæœºã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>volatile boolean shutdownRequested;
......
public void shutdown() { shutdownRequested = true; }
public void doWork() {
    while (!shutdownRequested) {
        // do stuff
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication-no-mean"><a href="#æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication-no-mean" class="header-anchor">#</a> æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)-no mean</h3> <p>ç¼ºä¹åŒæ­¥ä¼šå¯¼è‡´æ— æ³•å®ç°å¯è§æ€§ï¼Œè¿™ä½¿å¾—ç¡®å®šä½•æ—¶å†™å…¥å¯¹è±¡å¼•ç”¨è€Œä¸æ˜¯åŸå§‹å€¼å˜å¾—æ›´åŠ å›°éš¾ã€‚åœ¨ç¼ºä¹åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°æŸä¸ªå¯¹è±¡å¼•ç”¨çš„æ›´æ–°å€¼(ç”±å¦ä¸€ä¸ªçº¿ç¨‹å†™å…¥)å’Œè¯¥å¯¹è±¡çŠ¶æ€çš„æ—§å€¼åŒæ—¶å­˜åœ¨ã€‚(è¿™å°±æ˜¯é€ æˆè‘—åçš„åŒé‡æ£€æŸ¥é”å®š(double-checked-locking)é—®é¢˜çš„æ ¹æºï¼Œå…¶ä¸­å¯¹è±¡å¼•ç”¨åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹è¿›è¡Œè¯»æ“ä½œï¼Œäº§ç”Ÿçš„é—®é¢˜æ˜¯æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªæ›´æ–°çš„å¼•ç”¨ï¼Œä½†æ˜¯ä»ç„¶ä¼šé€šè¿‡è¯¥å¼•ç”¨çœ‹åˆ°ä¸å®Œå…¨æ„é€ çš„å¯¹è±¡)ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackgroundFloobleLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token class-name">Flooble</span> theFlooble<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initInBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do lots of stuff</span>
        theFlooble <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flooble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// this is the only write to theFlooble</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SomeOtherClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// do some stuff...</span>
            <span class="token comment">// use the Flooble, but only if it is ready</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>floobleLoader<span class="token punctuation">.</span>theFlooble <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token function">doSomething</span><span class="token punctuation">(</span>floobleLoader<span class="token punctuation">.</span>theFlooble<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation"><a href="#æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" class="header-anchor">#</a> <strong>æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)</strong></h3> <p>å®‰å…¨ä½¿ç”¨ volatile çš„å¦ä¸€ç§ç®€å•æ¨¡å¼æ˜¯å®šæœŸ å‘å¸ƒ è§‚å¯Ÿç»“æœä¾›ç¨‹åºå†…éƒ¨ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ç§ç¯å¢ƒä¼ æ„Ÿå™¨èƒ½å¤Ÿæ„Ÿè§‰ç¯å¢ƒæ¸©åº¦ã€‚ä¸€ä¸ªåå°çº¿ç¨‹å¯èƒ½ä¼šæ¯éš”å‡ ç§’è¯»å–ä¸€æ¬¡è¯¥ä¼ æ„Ÿå™¨ï¼Œå¹¶æ›´æ–°åŒ…å«å½“å‰æ–‡æ¡£çš„ volatile å˜é‡ã€‚ç„¶åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–è¿™ä¸ªå˜é‡ï¼Œä»è€Œéšæ—¶èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°çš„æ¸©åº¦å€¼ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> lastUser<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token function">passwordIsValid</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activeUsers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastUser <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="æ¨¡å¼4-volatile-bean-æ¨¡å¼"><a href="#æ¨¡å¼4-volatile-bean-æ¨¡å¼" class="header-anchor">#</a> <strong>æ¨¡å¼4ï¼švolatile bean æ¨¡å¼</strong></h3> <p>åœ¨ volatile bean æ¨¡å¼ä¸­ï¼ŒJavaBean çš„æ‰€æœ‰æ•°æ®æˆå‘˜éƒ½æ˜¯ volatile ç±»å‹çš„ï¼Œå¹¶ä¸” getter å’Œ setter æ–¹æ³•å¿…é¡»éå¸¸æ™®é€š â€”â€” é™¤äº†è·å–æˆ–è®¾ç½®ç›¸åº”çš„å±æ€§å¤–ï¼Œä¸èƒ½åŒ…å«ä»»ä½•é€»è¾‘ã€‚æ­¤å¤–ï¼Œå¯¹äºå¯¹è±¡å¼•ç”¨çš„æ•°æ®æˆå‘˜ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯æœ‰æ•ˆä¸å¯å˜çš„ã€‚(è¿™å°†ç¦æ­¢å…·æœ‰æ•°ç»„å€¼çš„å±æ€§ï¼Œå› ä¸ºå½“æ•°ç»„å¼•ç”¨è¢«å£°æ˜ä¸º volatile æ—¶ï¼Œåªæœ‰å¼•ç”¨è€Œä¸æ˜¯æ•°ç»„æœ¬èº«å…·æœ‰ volatile è¯­ä¹‰)ã€‚å¯¹äºä»»ä½• volatile å˜é‡ï¼Œä¸å˜å¼æˆ–çº¦æŸéƒ½ä¸èƒ½åŒ…å« JavaBean å±æ€§ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> firstName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> lastName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> firstName<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lastName<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> age<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFirstName</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> firstName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> lastName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥"><a href="#æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" class="header-anchor">#</a> <strong>æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥</strong></h3> <p>volatile çš„åŠŸèƒ½è¿˜ä¸è¶³ä»¥å®ç°è®¡æ•°å™¨ã€‚å› ä¸º ++x å®é™…ä¸Šæ˜¯ä¸‰ç§æ“ä½œ(è¯»ã€æ·»åŠ ã€å­˜å‚¨)çš„ç®€å•ç»„åˆï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å‡‘å·§è¯•å›¾åŒæ—¶å¯¹ volatile è®¡æ•°å™¨æ‰§è¡Œå¢é‡æ“ä½œï¼Œé‚£ä¹ˆå®ƒçš„æ›´æ–°å€¼æœ‰å¯èƒ½ä¼šä¸¢å¤±ã€‚
å¦‚æœè¯»æ“ä½œè¿œè¿œè¶…è¿‡å†™æ“ä½œï¼Œå¯ä»¥ç»“åˆä½¿ç”¨å†…éƒ¨é”å’Œ volatile å˜é‡æ¥å‡å°‘å…¬å…±ä»£ç è·¯å¾„çš„å¼€é”€ã€‚
å®‰å…¨çš„è®¡æ•°å™¨ä½¿ç”¨ synchronized ç¡®ä¿å¢é‡æ“ä½œæ˜¯åŸå­çš„ï¼Œå¹¶ä½¿ç”¨ volatile ä¿è¯å½“å‰ç»“æœçš„å¯è§æ€§ã€‚å¦‚æœæ›´æ–°ä¸é¢‘ç¹çš„è¯ï¼Œè¯¥æ–¹æ³•å¯å®ç°æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºè¯»è·¯å¾„çš„å¼€é”€ä»…ä»…æ¶‰åŠ volatile è¯»æ“ä½œï¼Œè¿™é€šå¸¸è¦ä¼˜äºä¸€ä¸ªæ— ç«äº‰çš„é”è·å–çš„å¼€é”€ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheesyCounter</span> <span class="token punctuation">{</span>
    <span class="token comment">// Employs the cheap read-write lock trick</span>
    <span class="token comment">// All mutative operations MUST be done with the 'this' lock held</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked"><a href="#æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" class="header-anchor">#</a> æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked)</h3> <p>å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡ä¸¾çš„ä¾‹å­ã€‚</p> <p>å•ä¾‹æ¨¡å¼çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œä½†å¾ˆå¤šäººä¼šå¿½ç•¥ volatile å…³é”®å­—ï¼Œå› ä¸ºæ²¡æœ‰è¯¥å…³é”®å­—ï¼Œç¨‹åºä¹Ÿå¯ä»¥å¾ˆå¥½çš„è¿è¡Œï¼Œåªä¸è¿‡ä»£ç çš„ç¨³å®šæ€§æ€»ä¸æ˜¯ 100%ï¼Œè¯´ä¸å®šåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œéšè—çš„ bug å°±å‡ºæ¥äº†ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">syschronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2022/1/16 ä¸‹åˆ5:24:46</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="prev">
        å…³é”®å­—-synchronized
      </a></span> <span class="next"><a href="/md/java/learn/å…³é”®å­—-final.html">
        å…³é”®å­—-final
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c015e375.js" defer></script><script src="/assets/js/5.ea3a467f.js" defer></script><script src="/assets/js/31.b0e9667f.js" defer></script>
  </body>
</html>
