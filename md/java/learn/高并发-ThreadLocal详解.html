<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>é«˜å¹¶å‘ - ThreadLocalè¯¦è§£ | ç§äººçŸ¥è¯†å›¾ä¹¦é¦†</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="åŒ…å«: Java åŸºç¡€, Java éƒ¨åˆ†æºç , JVM, Spring, Spring Boot, Spring Cloud, æ•°æ®åº“åŸç†, MySQL, ElasticSearch, MongoDB, Docker, k8s, CI&amp;CD, Linux, DevOps, åˆ†å¸ƒå¼, ä¸­é—´ä»¶, å¼€å‘å·¥å…·, Git, IDE, æºç é˜…è¯»ï¼Œè¯»ä¹¦ç¬”è®°, å¼€æºé¡¹ç›®...">
    <meta name="robots" content="all">
    <meta name="author" content="pdai">
    <meta name="keywords" content="ç§äººçŸ¥è¯†å›¾ä¹¦é¦†, javaä½“ç³», javaçŸ¥è¯†ä½“ç³», javaæ¡†æ¶,javaè¯¦è§£,javaå­¦ä¹ è·¯çº¿,java spring, javaé¢è¯•, çŸ¥è¯†ä½“ç³», javaæŠ€æœ¯ä½“ç³», javaç¼–ç¨‹, javaç¼–ç¨‹æŒ‡å—,javaå¼€å‘ä½“ç³», javaå¼€å‘,javaæ•™ç¨‹,java,javaæ•°æ®ç»“æ„, ç®—æ³•, å¼€å‘åŸºç¡€">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.cb877f3d.css" as="style"><link rel="preload" href="/assets/js/app.7437448f.js" as="script"><link rel="preload" href="/assets/js/5.ea3a467f.js" as="script"><link rel="preload" href="/assets/js/32.54420f34.js" as="script"><link rel="prefetch" href="/assets/js/10.5ef4c92a.js"><link rel="prefetch" href="/assets/js/11.3f596b90.js"><link rel="prefetch" href="/assets/js/12.b71be16f.js"><link rel="prefetch" href="/assets/js/13.d6271850.js"><link rel="prefetch" href="/assets/js/14.9ba4f8e3.js"><link rel="prefetch" href="/assets/js/15.62d14093.js"><link rel="prefetch" href="/assets/js/16.de77b749.js"><link rel="prefetch" href="/assets/js/17.b28c1669.js"><link rel="prefetch" href="/assets/js/18.65db727f.js"><link rel="prefetch" href="/assets/js/19.f0cab2cf.js"><link rel="prefetch" href="/assets/js/2.5197edd9.js"><link rel="prefetch" href="/assets/js/20.bc2a1ebe.js"><link rel="prefetch" href="/assets/js/21.9d44366f.js"><link rel="prefetch" href="/assets/js/22.8d7f32d4.js"><link rel="prefetch" href="/assets/js/23.7f7b97fc.js"><link rel="prefetch" href="/assets/js/24.b84a7d83.js"><link rel="prefetch" href="/assets/js/25.a12b8134.js"><link rel="prefetch" href="/assets/js/26.d6cf3bce.js"><link rel="prefetch" href="/assets/js/27.304e0d0a.js"><link rel="prefetch" href="/assets/js/28.12e94d0e.js"><link rel="prefetch" href="/assets/js/29.79c71861.js"><link rel="prefetch" href="/assets/js/3.310235c4.js"><link rel="prefetch" href="/assets/js/30.90aec520.js"><link rel="prefetch" href="/assets/js/31.59769de4.js"><link rel="prefetch" href="/assets/js/33.90c0c365.js"><link rel="prefetch" href="/assets/js/4.1fed06c3.js"><link rel="prefetch" href="/assets/js/6.6906b7c0.js"><link rel="prefetch" href="/assets/js/7.6030a7b8.js"><link rel="prefetch" href="/assets/js/8.15f570fb.js"><link rel="prefetch" href="/assets/js/9.bbacd143.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cb877f3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/favicon.ico" alt="ç§äººçŸ¥è¯†å›¾ä¹¦é¦†" class="logo"> <span class="site-name can-hide">ç§äººçŸ¥è¯†å›¾ä¹¦é¦†</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  æ¦‚è¿°
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/learn-typescript.html" class="nav-link">
  Typescript
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/ChromeExtensions.html" class="nav-link">
  ChromeExtensions
</a></li></ul></li><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Stream.html" class="nav-link">
  Stream
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Optional.html" class="nav-link">
  Optional
</a></li></ul></li><li class="dropdown-item"><h4>
          Javaé«˜å¹¶å‘
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="nav-link">
  Javaçº¿ç¨‹æ± 
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="nav-link">
  é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-ç†è®ºåŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="nav-link">
  å…³é”®å­—-synchronized
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="nav-link">
  å…³é”®å­—-volatile
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-final.html" class="nav-link">
  å…³é”®å­—-final
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="nav-link">
  é«˜å¹¶å‘-ThreadLocalè¯¦è§£
</a></li></ul></li><li class="dropdown-item"><h4>
          æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  Springç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="nav-link">
  SpringMVCç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Mybatisç¬”è®°.html" class="nav-link">
  Mybatisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="nav-link">
  MybatisPlusç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  SpringBootç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Dubboç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-zookeeper.html" class="nav-link">
  Zookeeperç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-redis.html" class="nav-link">
  Redisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-elasticstack.html" class="nav-link">
  Elasticstackç¬”è®°
</a></li></ul></li><li class="dropdown-item"><h4>
          JVM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="nav-link">
  JVMå¿«é€Ÿå…¥é—¨ç¯‡
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–¹æ³•è®º" class="dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–¹æ³•è®º" class="mobile-dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/method/è®¾è®¡æ¨¡å¼.html" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="mobile-dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/tool/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/md/java/tool/Mavenå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Maven
</a></li></ul></div></div><div class="nav-item"><a href="/md/about/about-me.html" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/amzpiper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  æ¦‚è¿°
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></button> <button type="button" aria-label="å­¦ä¹ ç¬”è®°" class="mobile-dropdown-title"><span class="title">å­¦ä¹ ç¬”è®°</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          å‰ç«¯
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/learn-typescript.html" class="nav-link">
  Typescript
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/ChromeExtensions.html" class="nav-link">
  ChromeExtensions
</a></li></ul></li><li class="dropdown-item"><h4>
          Java
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Stream.html" class="nav-link">
  Stream
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Java8-Optional.html" class="nav-link">
  Optional
</a></li></ul></li><li class="dropdown-item"><h4>
          Javaé«˜å¹¶å‘
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="nav-link">
  Javaçº¿ç¨‹æ± 
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="nav-link">
  é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="nav-link">
  é«˜å¹¶å‘-ç†è®ºåŸºç¡€
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="nav-link">
  å…³é”®å­—-synchronized
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="nav-link">
  å…³é”®å­—-volatile
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/å…³é”®å­—-final.html" class="nav-link">
  å…³é”®å­—-final
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="nav-link">
  é«˜å¹¶å‘-ThreadLocalè¯¦è§£
</a></li></ul></li><li class="dropdown-item"><h4>
          æ¡†æ¶
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  Springç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="nav-link">
  SpringMVCç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Mybatisç¬”è®°.html" class="nav-link">
  Mybatisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="nav-link">
  MybatisPlusç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Springç¬”è®°.html" class="nav-link">
  SpringBootç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Dubboç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-zookeeper.html" class="nav-link">
  Zookeeperç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-redis.html" class="nav-link">
  Redisç¬”è®°
</a></li><li class="dropdown-subitem"><a href="/md/java/learn/learn-elasticstack.html" class="nav-link">
  Elasticstackç¬”è®°
</a></li></ul></li><li class="dropdown-item"><h4>
          JVM
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="nav-link">
  JVMå¿«é€Ÿå…¥é—¨ç¯‡
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="æ–¹æ³•è®º" class="dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow down"></span></button> <button type="button" aria-label="æ–¹æ³•è®º" class="mobile-dropdown-title"><span class="title">æ–¹æ³•è®º</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/method/è®¾è®¡æ¨¡å¼.html" class="nav-link">
  è®¾è®¡æ¨¡å¼
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow down"></span></button> <button type="button" aria-label="ç‰ˆæœ¬å·¥å…·" class="mobile-dropdown-title"><span class="title">ç‰ˆæœ¬å·¥å…·</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/java/tool/Git.html" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/md/java/tool/Mavenå­¦ä¹ ç¬”è®°.html" class="nav-link">
  Maven
</a></li></ul></div></div><div class="nav-item"><a href="/md/about/about-me.html" class="nav-link">
  å…³äº
</a></div><div class="nav-item"><a href="https://github.com/amzpiper" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å‰ç«¯</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/learn-typescript.html" class="sidebar-link">TypeScript</a></li><li><a href="/md/java/learn/ChromeExtensions.html" class="sidebar-link">Chrome Extensions</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Java8-Stream.html" class="sidebar-link">Java 8 - Stream</a></li><li><a href="/md/java/learn/Java8-Optional.html" class="sidebar-link">Java 8 - Optional</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Javaé«˜å¹¶å‘</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Javaçº¿ç¨‹æ± .html" class="sidebar-link">Java çº¿ç¨‹æ± </a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³».html" class="sidebar-link">é«˜å¹¶å‘-çŸ¥è¯†ä½“ç³»</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€.html" class="sidebar-link">é«˜å¹¶å‘-çº¿ç¨‹åŸºç¡€</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-ç†è®ºåŸºç¡€.html" class="sidebar-link">é«˜å¹¶å‘-ç†è®ºåŸºç¡€</a></li><li><a href="/md/java/learn/å…³é”®å­—-synchronized.html" class="sidebar-link">å…³é”®å­—-synchronized</a></li><li><a href="/md/java/learn/å…³é”®å­—-volatile.html" class="sidebar-link">å…³é”®å­—-volatile</a></li><li><a href="/md/java/learn/å…³é”®å­—-final.html" class="sidebar-link">å…³é”®å­—-final</a></li><li><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html" class="active sidebar-link">é«˜å¹¶å‘ - ThreadLocalè¯¦è§£</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£" class="sidebar-link">å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#threadlocalç®€ä»‹" class="sidebar-link">ThreadLocalç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#threadlocalç†è§£" class="sidebar-link">ThreadLocalç†è§£</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#threadlocalåŸç†" class="sidebar-link">ThreadLocalåŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»" class="sidebar-link">å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#threadlocalmapå¯¹è±¡æ˜¯ä»€ä¹ˆ" class="sidebar-link">ThreadLocalMapå¯¹è±¡æ˜¯ä»€ä¹ˆ</a></li></ul></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#threadlocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜" class="sidebar-link">ThreadLocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#å†çœ‹threadlocalåº”ç”¨åœºæ™¯" class="sidebar-link">å†çœ‹ThreadLocalåº”ç”¨åœºæ™¯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ª-åºåˆ—å·" class="sidebar-link">æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªâ€œåºåˆ—å·â€</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#sessionçš„ç®¡ç†" class="sidebar-link">Sessionçš„ç®¡ç†</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#åœ¨çº¿ç¨‹å†…éƒ¨åˆ›å»ºthreadlocal" class="sidebar-link">åœ¨çº¿ç¨‹å†…éƒ¨åˆ›å»ºThreadLocal</a></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#java-å¼€å‘æ‰‹å†Œä¸­æ¨èçš„-threadlocal" class="sidebar-link">java å¼€å‘æ‰‹å†Œä¸­æ¨èçš„ ThreadLocal</a></li></ul></li><li class="sidebar-sub-header"><a href="/md/java/learn/é«˜å¹¶å‘-ThreadLocalè¯¦è§£.html#å‚è€ƒæ–‡ç« " class="sidebar-link">å‚è€ƒæ–‡ç« </a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æ¡†æ¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/Springç¬”è®°.html" class="sidebar-link">Spring</a></li><li><a href="/md/java/learn/Spring-MVCç¬”è®°.html" class="sidebar-link">SpringMVC</a></li><li><a href="/md/java/learn/Mybatisç¬”è®°.html" class="sidebar-link">Mybatis</a></li><li><a href="/md/java/learn/MybatisPlusç¬”è®°.html" class="sidebar-link">Mybatis-Plus</a></li><li><a href="/md/java/learn/SpringBootç¬”è®°.html" class="sidebar-link">SpringBoot</a></li><li><a href="/md/java/learn/learn-zookeeper.html" class="sidebar-link">Zookeeper</a></li><li><a href="/md/java/learn/learn-redis.html" class="sidebar-link">Redis</a></li><li><a href="/md/java/learn/learn-elasticstack.html" class="sidebar-link">Elasticstack</a></li><li><a href="/md/java/learn/Dubboå­¦ä¹ ç¬”è®°.html" class="sidebar-link">Dubbo</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/md/java/learn/JVMå¿«é€Ÿå…¥é—¨ç¯‡.html" class="sidebar-link">JVMå¿«é€Ÿå…¥é—¨ç¯‡</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="é«˜å¹¶å‘-threadlocalè¯¦è§£"><a href="#é«˜å¹¶å‘-threadlocalè¯¦è§£" class="header-anchor">#</a> é«˜å¹¶å‘ - ThreadLocalè¯¦è§£</h1> <aside>
ğŸ’¡ ThreadLocalæ˜¯é€šè¿‡çº¿ç¨‹éš”ç¦»çš„æ–¹å¼é˜²æ­¢ä»»åŠ¡åœ¨å…±äº«èµ„æºä¸Šäº§ç”Ÿå†²çª, çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ˜¯ä¸€ç§è‡ªåŠ¨åŒ–æœºåˆ¶ï¼Œå¯ä»¥ä¸ºä½¿ç”¨ç›¸åŒå˜é‡çš„æ¯ä¸ªä¸åŒçº¿ç¨‹éƒ½åˆ›å»ºä¸åŒçš„å­˜å‚¨ã€‚
</aside> <h2 id="å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£"><a href="#å¸¦ç€batå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£" class="header-anchor">#</a> å¸¦ç€BATå¤§å‚çš„é¢è¯•é—®é¢˜å»ç†è§£</h2> <aside>
ğŸ’¡ è¯·å¸¦ç€è¿™äº›é—®é¢˜ç»§ç»­åæ–‡ï¼Œä¼šå¾ˆå¤§ç¨‹åº¦ä¸Šå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£ç›¸å…³çŸ¥è¯†ç‚¹ã€‚@pdai
</aside> <ul><li>ä»€ä¹ˆæ˜¯ThreadLocal? ç”¨æ¥<strong>è§£å†³ä»€ä¹ˆé—®é¢˜</strong>çš„?</li> <li>è¯´è¯´ä½ å¯¹ThreadLocalçš„<strong>ç†è§£</strong></li> <li>ThreadLocalæ˜¯<strong>å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»</strong>çš„?</li> <li>ä¸ºä»€ä¹ˆThreadLocalä¼š<strong>é€ æˆå†…å­˜æ³„éœ²</strong>? <strong>å¦‚ä½•è§£å†³</strong></li> <li>è¿˜æœ‰å“ªäº›ä½¿ç”¨ThreadLocalçš„<strong>åº”ç”¨åœºæ™¯</strong>?</li></ul> <h2 id="threadlocalç®€ä»‹"><a href="#threadlocalç®€ä»‹" class="header-anchor">#</a> ThreadLocalç®€ä»‹</h2> <p>æˆ‘ä»¬åœ¨<a href="/md/java/learn/notion://www.notion.so/md/java/thread/java-thread-x-theorty.html#çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•">Java å¹¶å‘ - å¹¶å‘ç†è®ºåŸºç¡€</a>æ€»ç»“è¿‡çº¿ç¨‹å®‰å…¨(æ˜¯æŒ‡å¹¿ä¹‰ä¸Šçš„å…±äº«èµ„æºè®¿é—®å®‰å…¨æ€§ï¼Œå› ä¸ºçº¿ç¨‹éš”ç¦»æ˜¯é€šè¿‡å‰¯æœ¬ä¿è¯æœ¬çº¿ç¨‹è®¿é—®èµ„æºå®‰å…¨æ€§ï¼Œå®ƒä¸ä¿è¯çº¿ç¨‹ä¹‹é—´è¿˜å­˜åœ¨å…±äº«å…³ç³»çš„ç‹­ä¹‰ä¸Šçš„å®‰å…¨æ€§)çš„è§£å†³æ€è·¯ï¼š</p> <ul><li>äº’æ–¥åŒæ­¥: synchronized å’Œ ReentrantLock</li> <li>éé˜»å¡åŒæ­¥: CAS, AtomicXXXX</li> <li>æ— åŒæ­¥æ–¹æ¡ˆ: æ ˆå°é—­ï¼Œæœ¬åœ°å­˜å‚¨(Thread Local)ï¼Œå¯é‡å…¥ä»£ç </li></ul> <p>è¿™ä¸ªç« èŠ‚å°†è¯¦ç»†çš„è®²è®² æœ¬åœ°å­˜å‚¨(Thread Local)ã€‚å®˜ç½‘çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š</p> <blockquote><p>This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its {@code get} or {@code set} method) has its own, independently initialized copy of the variable. {@code ThreadLocal} instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID)
è¯¥ç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨ (thread-local) å˜é‡ã€‚è¿™äº›å˜é‡ä¸åŒäºå®ƒä»¬çš„æ™®é€šå¯¹åº”ç‰©ï¼Œå› ä¸ºè®¿é—®æŸä¸ªå˜é‡(é€šè¿‡å…¶ get æˆ– set æ–¹æ³•)çš„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œå®ƒç‹¬ç«‹äºå˜é‡çš„åˆå§‹åŒ–å‰¯æœ¬ã€‚ThreadLocal å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ private static å­—æ®µï¼Œå®ƒä»¬å¸Œæœ›å°†çŠ¶æ€ä¸æŸä¸€ä¸ªçº¿ç¨‹(ä¾‹å¦‚ï¼Œç”¨æˆ· ID æˆ–äº‹åŠ¡ ID)ç›¸å…³è”ã€‚</p></blockquote> <p>æ€»ç»“è€Œè¨€ï¼šThreadLocalæ˜¯ä¸€ä¸ªå°†åœ¨å¤šçº¿ç¨‹ä¸­ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬çš„ç±»; å½“ä½¿ç”¨ThreadLocalæ¥ç»´æŠ¤å˜é‡æ—¶, ThreadLocalä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬, é¿å…å› å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p> <h2 id="threadlocalç†è§£"><a href="#threadlocalç†è§£" class="header-anchor">#</a> ThreadLocalç†è§£</h2> <blockquote><p>æåˆ°ThreadLocalè¢«æåˆ°åº”ç”¨æœ€å¤šçš„æ˜¯<strong>sessionç®¡ç†</strong>å’Œ<strong>æ•°æ®åº“é“¾æ¥ç®¡ç†</strong>ï¼Œè¿™é‡Œä»¥æ•°æ®è®¿é—®ä¸ºä¾‹å¸®åŠ©ä½ ç†è§£ThreadLocalï¼š</p></blockquote> <ul><li>å¦‚ä¸‹æ•°æ®åº“ç®¡ç†ç±»åœ¨å•çº¿ç¨‹ä½¿ç”¨æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> connect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connect <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            connect <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> connect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connect <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            connect<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>å¾ˆæ˜¾ç„¶ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼šç¬¬ä¸€ï¼Œè¿™é‡Œé¢çš„2ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰è¿›è¡ŒåŒæ­¥ï¼Œå¾ˆå¯èƒ½åœ¨openConnectionæ–¹æ³•ä¸­ä¼šå¤šæ¬¡åˆ›å»ºconnectï¼›ç¬¬äºŒï¼Œç”±äºconnectæ˜¯å…±äº«å˜é‡ï¼Œé‚£ä¹ˆå¿…ç„¶åœ¨è°ƒç”¨connectçš„åœ°æ–¹éœ€è¦ä½¿ç”¨åˆ°åŒæ­¥æ¥ä¿éšœçº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå¾ˆå¯èƒ½ä¸€ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨connectè¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨closeConnectionå…³é—­é“¾æ¥ã€‚</p> <ul><li>ä¸ºäº†è§£å†³ä¸Šè¿°çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œç¬¬ä¸€è€ƒè™‘ï¼šäº’æ–¥åŒæ­¥</li></ul> <p>ä½ å¯èƒ½ä¼šè¯´ï¼Œå°†è¿™æ®µä»£ç çš„ä¸¤ä¸ªæ–¹æ³•è¿›è¡ŒåŒæ­¥å¤„ç†ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨connectçš„åœ°æ–¹éœ€è¦è¿›è¡ŒåŒæ­¥å¤„ç†ï¼Œæ¯”å¦‚ç”¨Synchronizedæˆ–è€…ReentrantLockäº’æ–¥é”ã€‚</p> <ul><li>è¿™é‡Œå†æŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šè¿™åœ°æ–¹åˆ°åº•éœ€ä¸éœ€è¦å°†connectå˜é‡è¿›è¡Œå…±äº«?</li></ul> <p>äº‹å®ä¸Šï¼Œæ˜¯ä¸éœ€è¦çš„ã€‚å‡å¦‚æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªconnectå˜é‡ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å¯¹connectå˜é‡çš„è®¿é—®å®é™…ä¸Šæ˜¯æ²¡æœ‰ä¾èµ–å…³ç³»çš„ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¸éœ€è¦å…³å¿ƒå…¶ä»–çº¿ç¨‹æ˜¯å¦å¯¹è¿™ä¸ªconnectè¿›è¡Œäº†ä¿®æ”¹çš„ã€‚å³æ”¹åçš„ä»£ç å¯ä»¥è¿™æ ·ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Connection</span> connect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connect <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            connect <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> connect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connect <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            connect<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Dao</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConnectionManager</span> connectionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä½¿ç”¨connectionè¿›è¡Œæ“ä½œ</span>

        connectionManager<span class="token punctuation">.</span><span class="token function">closeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>è¿™æ ·å¤„ç†ç¡®å®ä¹Ÿæ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œç”±äºæ¯æ¬¡éƒ½æ˜¯åœ¨æ–¹æ³•å†…éƒ¨åˆ›å»ºçš„è¿æ¥ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¹‹é—´è‡ªç„¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä½†æ˜¯è¿™æ ·ä¼šæœ‰ä¸€ä¸ªè‡´å‘½çš„å½±å“ï¼šå¯¼è‡´æœåŠ¡å™¨å‹åŠ›éå¸¸å¤§ï¼Œå¹¶ä¸”ä¸¥é‡å½±å“ç¨‹åºæ‰§è¡Œæ€§èƒ½ã€‚ç”±äºåœ¨æ–¹æ³•ä¸­éœ€è¦é¢‘ç¹åœ°å¼€å¯å’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œè¿™æ ·ä¸ä»…ä¸¥é‡å½±å“ç¨‹åºæ‰§è¡Œæ•ˆç‡ï¼Œè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡å™¨å‹åŠ›å·¨å¤§ã€‚</p> <ul><li>è¿™æ—¶å€™ThreadLocalç™»åœºäº†</li></ul> <p>é‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ThreadLocalæ˜¯å†é€‚åˆä¸è¿‡çš„äº†ï¼Œå› ä¸ºThreadLocalåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹è¯¥å˜é‡ä¼šåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œå³æ¯ä¸ªçº¿ç¨‹å†…éƒ¨éƒ½ä¼šæœ‰ä¸€ä¸ªè¯¥å˜é‡ï¼Œä¸”åœ¨çº¿ç¨‹å†…éƒ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ï¼Œçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ï¼Œè¿™æ ·ä¸€æ¥å°±ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¹Ÿä¸ä¼šä¸¥é‡å½±å“ç¨‹åºæ‰§è¡Œæ€§èƒ½ã€‚ä¸‹é¢å°±æ˜¯ç½‘ä¸Šå‡ºç°æœ€å¤šçš„ä¾‹å­ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> dbConnectionLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">Connection</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dbConnectionLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>å†æ³¨æ„ä¸‹ThreadLocalçš„ä¿®é¥°ç¬¦</li></ul> <p>ThreaLocalçš„JDKæ–‡æ¡£ä¸­è¯´æ˜ï¼šThreadLocal instances are typically private static fields in classes that wish to associate state with a threadã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›é€šè¿‡æŸä¸ªç±»å°†çŠ¶æ€(ä¾‹å¦‚ç”¨æˆ·IDã€äº‹åŠ¡ID)ä¸çº¿ç¨‹å…³è”èµ·æ¥ï¼Œé‚£ä¹ˆé€šå¸¸åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰private staticç±»å‹çš„ThreadLocal å®ä¾‹ã€‚</p> <blockquote><p>ä½†æ˜¯è¦æ³¨æ„ï¼Œè™½ç„¶ThreadLocalèƒ½å¤Ÿè§£å†³ä¸Šé¢è¯´çš„é—®é¢˜ï¼Œä½†æ˜¯ç”±äºåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†å‰¯æœ¬ï¼Œæ‰€ä»¥è¦è€ƒè™‘å®ƒå¯¹èµ„æºçš„æ¶ˆè€—ï¼Œæ¯”å¦‚å†…å­˜çš„å ç”¨ä¼šæ¯”ä¸ä½¿ç”¨ThreadLocalè¦å¤§ã€‚</p></blockquote> <h2 id="threadlocalåŸç†"><a href="#threadlocalåŸç†" class="header-anchor">#</a> ThreadLocalåŸç†</h2> <h3 id="å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»"><a href="#å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»" class="header-anchor">#</a> å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»</h3> <p>ä¸»è¦æ˜¯ç”¨åˆ°äº†Threadå¯¹è±¡ä¸­çš„ä¸€ä¸ªThreadLocalMapç±»å‹çš„å˜é‡threadLocals, è´Ÿè´£å­˜å‚¨å½“å‰çº¿ç¨‹çš„å…³äºConnectionçš„å¯¹è±¡, dbConnectionLocal(ä»¥ä¸Šè¿°ä¾‹å­ä¸­ä¸ºä¾‹) è¿™ä¸ªå˜é‡ä¸ºKey, ä»¥æ–°å»ºçš„Connectionå¯¹è±¡ä¸ºValue; è¿™æ ·çš„è¯, çº¿ç¨‹ç¬¬ä¸€æ¬¡è¯»å–çš„æ—¶å€™å¦‚æœä¸å­˜åœ¨å°±ä¼šè°ƒç”¨ThreadLocalçš„initialValueæ–¹æ³•åˆ›å»ºä¸€ä¸ªConnectionå¯¹è±¡å¹¶ä¸”è¿”å›;</p> <p>å…·ä½“å…³äºä¸ºçº¿ç¨‹åˆ†é…å˜é‡å‰¯æœ¬çš„ä»£ç å¦‚ä¸‹:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>é¦–å…ˆè·å–å½“å‰çº¿ç¨‹å¯¹è±¡t, ç„¶åä»çº¿ç¨‹tä¸­è·å–åˆ°ThreadLocalMapçš„æˆå‘˜å±æ€§threadLocals</li> <li>å¦‚æœå½“å‰çº¿ç¨‹çš„threadLocalså·²ç»åˆå§‹åŒ–(å³ä¸ä¸ºnull) å¹¶ä¸”å­˜åœ¨ä»¥å½“å‰ThreadLocalå¯¹è±¡ä¸ºKeyçš„å€¼, åˆ™ç›´æ¥è¿”å›å½“å‰çº¿ç¨‹è¦è·å–çš„å¯¹è±¡(æœ¬ä¾‹ä¸­ä¸ºConnection);</li> <li>å¦‚æœå½“å‰çº¿ç¨‹çš„threadLocalså·²ç»åˆå§‹åŒ–(å³ä¸ä¸ºnull)ä½†æ˜¯ä¸å­˜åœ¨ä»¥å½“å‰ThreadLocalå¯¹è±¡ä¸ºKeyçš„çš„å¯¹è±¡, é‚£ä¹ˆé‡æ–°åˆ›å»ºä¸€ä¸ªConnectionå¯¹è±¡, å¹¶ä¸”æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„threadLocals Mapä¸­,å¹¶è¿”å›</li> <li>å¦‚æœå½“å‰çº¿ç¨‹çš„threadLocalså±æ€§è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–, åˆ™é‡æ–°åˆ›å»ºä¸€ä¸ªThreadLocalMapå¯¹è±¡, å¹¶ä¸”åˆ›å»ºä¸€ä¸ªConnectionå¯¹è±¡å¹¶æ·»åŠ åˆ°ThreadLocalMapå¯¹è±¡ä¸­å¹¶è¿”å›ã€‚</li></ul> <p>å¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›å¾ˆå¥½ç†è§£, é‚£ä¹ˆå¯¹äºå¦‚ä½•åˆå§‹åŒ–çš„ä»£ç åˆæ˜¯æ€æ ·çš„å‘¢?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>é¦–å…ˆè°ƒç”¨æˆ‘ä»¬ä¸Šé¢å†™çš„é‡è½½è¿‡åçš„initialValueæ–¹æ³•, äº§ç”Ÿä¸€ä¸ªConnectionå¯¹è±¡</li> <li>ç»§ç»­æŸ¥çœ‹å½“å‰çº¿ç¨‹çš„threadLocalsæ˜¯ä¸æ˜¯ç©ºçš„, å¦‚æœThreadLocalMapå·²è¢«åˆå§‹åŒ–, é‚£ä¹ˆç›´æ¥å°†äº§ç”Ÿçš„å¯¹è±¡æ·»åŠ åˆ°ThreadLocalMapä¸­, å¦‚æœæ²¡æœ‰åˆå§‹åŒ–, åˆ™åˆ›å»ºå¹¶æ·»åŠ å¯¹è±¡åˆ°å…¶ä¸­;</li></ul> <p>åŒæ—¶, ThreadLocalè¿˜æä¾›äº†ç›´æ¥æ“ä½œThreadå¯¹è±¡ä¸­çš„threadLocalsçš„æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¿™æ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸å®ç°initialValue, å°†åˆå§‹åŒ–å·¥ä½œæ”¾åˆ°DBConnectionFactoryçš„getConnectionæ–¹æ³•ä¸­:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> dbConnectionLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            connection <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dbConnectionLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>é‚£ä¹ˆæˆ‘ä»¬çœ‹è¿‡ä»£ç ä¹‹åå°±å¾ˆæ¸…æ™°çš„çŸ¥é“äº†ä¸ºä»€ä¹ˆThreadLocalèƒ½å¤Ÿå®ç°å˜é‡çš„å¤šçº¿ç¨‹éš”ç¦»äº†; å…¶å®å°±æ˜¯ç”¨äº†Mapçš„æ•°æ®ç»“æ„ç»™å½“å‰çº¿ç¨‹ç¼“å­˜äº†, è¦ä½¿ç”¨çš„æ—¶å€™å°±ä»æœ¬çº¿ç¨‹çš„threadLocalså¯¹è±¡ä¸­è·å–å°±å¯ä»¥äº†, keyå°±æ˜¯å½“å‰çº¿ç¨‹;</p> <p>å½“ç„¶äº†åœ¨å½“å‰çº¿ç¨‹ä¸‹è·å–å½“å‰çº¿ç¨‹é‡Œé¢çš„Mapé‡Œé¢çš„å¯¹è±¡å¹¶æ“ä½œè‚¯å®šæ²¡æœ‰çº¿ç¨‹å¹¶å‘é—®é¢˜äº†, å½“ç„¶èƒ½åšåˆ°å˜é‡çš„çº¿ç¨‹é—´éš”ç¦»äº†;</p> <p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ThreadLocalåˆ°åº•æ˜¯ä»€ä¹ˆäº†, åˆçŸ¥é“äº†å¦‚ä½•ä½¿ç”¨ThreadLocalä»¥åŠå…¶åŸºæœ¬å®ç°åŸç†äº†æ˜¯ä¸æ˜¯å°±å¯ä»¥ç»“æŸäº†å‘¢? å…¶å®è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ThreadLocalMapæ˜¯ä¸ªä»€ä¹ˆå¯¹è±¡, ä¸ºä»€ä¹ˆè¦ç”¨è¿™ä¸ªå¯¹è±¡å‘¢?</p> <h3 id="threadlocalmapå¯¹è±¡æ˜¯ä»€ä¹ˆ"><a href="#threadlocalmapå¯¹è±¡æ˜¯ä»€ä¹ˆ" class="header-anchor">#</a> ThreadLocalMapå¯¹è±¡æ˜¯ä»€ä¹ˆ</h3> <p>æœ¬è´¨ä¸Šæ¥è®², å®ƒå°±æ˜¯ä¸€ä¸ªMap, ä½†æ˜¯è¿™ä¸ªThreadLocalMapä¸æˆ‘ä»¬å¹³æ—¶è§åˆ°çš„Mapæœ‰ç‚¹ä¸ä¸€æ ·</p> <ul><li>å®ƒæ²¡æœ‰å®ç°Mapæ¥å£;</li> <li>å®ƒæ²¡æœ‰publicçš„æ–¹æ³•, æœ€å¤šæœ‰ä¸€ä¸ªdefaultçš„æ„é€ æ–¹æ³•, å› ä¸ºè¿™ä¸ªThreadLocalMapçš„æ–¹æ³•ä»…ä»…åœ¨ThreadLocalç±»ä¸­è°ƒç”¨, å±äºé™æ€å†…éƒ¨ç±»</li> <li>ThreadLocalMapçš„Entryå®ç°ç»§æ‰¿äº†WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</li> <li>è¯¥æ–¹æ³•ä»…ä»…ç”¨äº†ä¸€ä¸ªEntryæ•°ç»„æ¥å­˜å‚¨Key, Value; Entryå¹¶ä¸æ˜¯é“¾è¡¨å½¢å¼, è€Œæ˜¯æ¯ä¸ªbucketé‡Œé¢ä»…ä»…æ”¾ä¸€ä¸ªEntry;</li></ul> <p>è¦äº†è§£ThreadLocalMapçš„å®ç°, æˆ‘ä»¬å…ˆä»å…¥å£å¼€å§‹, å°±æ˜¯å¾€è¯¥Mapä¸­æ·»åŠ ä¸€ä¸ªå€¼:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// We don't use a fast path as with get() because it is at</span>
    <span class="token comment">// least as common to use set() to create new entries as</span>
    <span class="token comment">// it is to replace existing ones, in which case, a fast</span>
    <span class="token comment">// path would fail more often than not.</span>

    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
        <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

        <span class="token annotation punctuation">@pdai</span><span class="token operator">:</span> ä»£ç å·²ç»å¤åˆ¶åˆ°å‰ªè´´æ¿

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>å…ˆè¿›è¡Œç®€å•çš„åˆ†æ, å¯¹è¯¥ä»£ç è¡¨å±‚æ„æ€è¿›è¡Œè§£è¯»:</p> <ul><li>çœ‹ä¸‹å½“å‰threadLocalçš„åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½® æ¯”å¦‚: <code>i = 2</code>, çœ‹ <code>i = 2</code> ä½ç½®ä¸Šé¢çš„å…ƒç´ (Entry)çš„<code>Key</code>æ˜¯å¦ç­‰äºthreadLocal è¿™ä¸ª Key, å¦‚æœç­‰äºå°±å¾ˆå¥½è¯´äº†, ç›´æ¥å°†è¯¥ä½ç½®ä¸Šé¢çš„Entryçš„Valueæ›¿æ¢æˆæœ€æ–°çš„å°±å¯ä»¥äº†;</li> <li>å¦‚æœå½“å‰ä½ç½®ä¸Šé¢çš„ Entry çš„ Keyä¸ºç©º, è¯´æ˜ThreadLocalå¯¹è±¡å·²ç»è¢«å›æ”¶äº†, é‚£ä¹ˆå°±è°ƒç”¨replaceStaleEntry</li> <li>å¦‚æœæ¸…ç†å®Œæ— ç”¨æ¡ç›®(ThreadLocalè¢«å›æ”¶çš„æ¡ç›®)ã€å¹¶ä¸”æ•°ç»„ä¸­çš„æ•°æ®å¤§å° &gt; é˜ˆå€¼çš„æ—¶å€™å¯¹å½“å‰çš„Tableè¿›è¡Œé‡æ–°å“ˆå¸Œ
æ‰€ä»¥, è¯¥HashMapæ˜¯å¤„ç†å†²çªæ£€æµ‹çš„æœºåˆ¶æ˜¯å‘åç§»ä½, æ¸…é™¤è¿‡æœŸæ¡ç›® æœ€ç»ˆæ‰¾åˆ°åˆé€‚çš„ä½ç½®;</li></ul> <p>äº†è§£å®ŒSetæ–¹æ³•, åé¢å°±æ˜¯Getæ–¹æ³•äº†:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>private Entry getEntry(ThreadLocal&lt;?&gt; key) {
    int i = key.threadLocalHashCode &amp; (table.length - 1);
    Entry e = table[i];
    if (e != null &amp;&amp; e.get() == key)
        return e;
    else
        return getEntryAfterMiss(key, i, e);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>å…ˆæ‰¾åˆ°ThreadLocalçš„ç´¢å¼•ä½ç½®, å¦‚æœç´¢å¼•ä½ç½®å¤„çš„entryä¸ä¸ºç©ºå¹¶ä¸”é”®ä¸threadLocalæ˜¯åŒä¸€ä¸ªå¯¹è±¡, åˆ™ç›´æ¥è¿”å›; å¦åˆ™å»åé¢çš„ç´¢å¼•ä½ç½®ç»§ç»­æŸ¥æ‰¾ã€‚</p> <h2 id="threadlocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜"><a href="#threadlocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜" class="header-anchor">#</a> ThreadLocalé€ æˆå†…å­˜æ³„éœ²çš„é—®é¢˜</h2> <p>ç½‘ä¸Šæœ‰è¿™æ ·ä¸€ä¸ªä¾‹å­ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">LocalVariable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// (1)</span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> poolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// (2)</span>
    <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalVariable</span><span class="token punctuation">&gt;</span></span> localVariable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalVariable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// (3)</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            poolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// (4)</span>
                    localVariable<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LocalVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// (5)</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;use local varaible&quot;</span> <span class="token operator">+</span> localVariable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    localVariable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// (6)</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;pool execute over&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>å¦‚æœç”¨çº¿ç¨‹æ± æ¥æ“ä½œThreadLocal å¯¹è±¡ç¡®å®ä¼šé€ æˆå†…å­˜æ³„éœ², å› ä¸ºå¯¹äºçº¿ç¨‹æ± é‡Œé¢ä¸ä¼šé”€æ¯çš„çº¿ç¨‹, é‡Œé¢æ€»ä¼šå­˜åœ¨ç€<code>&lt;ThreadLocal, LocalVariable&gt;</code>çš„å¼ºå¼•ç”¨, å› ä¸ºfinal static ä¿®é¥°çš„ ThreadLocal å¹¶ä¸ä¼šé‡Šæ”¾, è€ŒThreadLocalMap å¯¹äº Key è™½ç„¶æ˜¯å¼±å¼•ç”¨, ä½†æ˜¯å¼ºå¼•ç”¨ä¸ä¼šé‡Šæ”¾, å¼±å¼•ç”¨å½“ç„¶ä¹Ÿä¼šä¸€ç›´æœ‰å€¼, åŒæ—¶åˆ›å»ºçš„LocalVariableå¯¹è±¡ä¹Ÿä¸ä¼šé‡Šæ”¾, å°±é€ æˆäº†å†…å­˜æ³„éœ²; å¦‚æœLocalVariableå¯¹è±¡ä¸æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡çš„è¯, å…¶å®æ³„éœ²çš„å¹¶ä¸ä¸¥é‡, <code>æ³„éœ²çš„å†…å­˜ = æ ¸å¿ƒçº¿ç¨‹æ•° * LocalVariable</code>å¯¹è±¡çš„å¤§å°;</p> <p>æ‰€ä»¥, ä¸ºäº†é¿å…å‡ºç°å†…å­˜æ³„éœ²çš„æƒ…å†µ, ThreadLocalæä¾›äº†ä¸€ä¸ªæ¸…é™¤çº¿ç¨‹ä¸­å¯¹è±¡çš„æ–¹æ³•, å³ remove, å…¶å®å†…éƒ¨å®ç°å°±æ˜¯è°ƒç”¨ ThreadLocalMap çš„removeæ–¹æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

        <span class="token annotation punctuation">@pdai</span><span class="token operator">:</span> ä»£ç å·²ç»å¤åˆ¶åˆ°å‰ªè´´æ¿

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>æ‰¾åˆ°Keyå¯¹åº”çš„Entry, å¹¶ä¸”æ¸…é™¤Entryçš„Key(ThreadLocal)ç½®ç©º, éšåæ¸…é™¤è¿‡æœŸçš„Entryå³å¯é¿å…å†…å­˜æ³„éœ²ã€‚</p> <h2 id="å†çœ‹threadlocalåº”ç”¨åœºæ™¯"><a href="#å†çœ‹threadlocalåº”ç”¨åœºæ™¯" class="header-anchor">#</a> å†çœ‹ThreadLocalåº”ç”¨åœºæ™¯</h2> <p>é™¤äº†ä¸Šè¿°çš„æ•°æ®åº“ç®¡ç†ç±»çš„ä¾‹å­ï¼Œæˆ‘ä»¬å†çœ‹çœ‹å…¶å®ƒä¸€äº›åº”ç”¨ï¼š</p> <h3 id="æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ª-åºåˆ—å·"><a href="#æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ª-åºåˆ—å·" class="header-anchor">#</a> æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªâ€œåºåˆ—å·â€</h3> <blockquote><p>å†å›æƒ³ä¸Šæ–‡è¯´çš„ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›é€šè¿‡æŸä¸ªç±»å°†çŠ¶æ€(ä¾‹å¦‚ç”¨æˆ·IDã€äº‹åŠ¡ID)ä¸çº¿ç¨‹å…³è”èµ·æ¥ï¼Œé‚£ä¹ˆé€šå¸¸åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰private staticç±»å‹çš„ThreadLocal å®ä¾‹ã€‚</p></blockquote> <p>æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªâ€œåºåˆ—å·â€</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerialNum</span> <span class="token punctuation">{</span>
    <span class="token comment">// The next serial number to be assigned</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> nextSerialNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span> serialNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">Object</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>nextSerialNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>serialNum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="sessionçš„ç®¡ç†"><a href="#sessionçš„ç®¡ç†" class="header-anchor">#</a> Sessionçš„ç®¡ç†</h3> <p>ç»å…¸çš„å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span> threadSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Session</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InfrastructureException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Session</span> s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Session</span><span class="token punctuation">)</span> threadSession<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">=</span> <span class="token function">getSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            threadSession<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HibernateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InfrastructureException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="åœ¨çº¿ç¨‹å†…éƒ¨åˆ›å»ºthreadlocal"><a href="#åœ¨çº¿ç¨‹å†…éƒ¨åˆ›å»ºthreadlocal" class="header-anchor">#</a> åœ¨çº¿ç¨‹å†…éƒ¨åˆ›å»ºThreadLocal</h3> <p>è¿˜æœ‰ä¸€ç§ç”¨æ³•æ˜¯åœ¨çº¿ç¨‹ç±»å†…éƒ¨åˆ›å»ºThreadLocalï¼ŒåŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p> <ul><li>åœ¨å¤šçº¿ç¨‹çš„ç±»(å¦‚ThreadDemoç±»)ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡threadXxxï¼Œç”¨æ¥ä¿å­˜çº¿ç¨‹é—´éœ€è¦éš”ç¦»å¤„ç†çš„å¯¹è±¡xxxã€‚</li> <li>åœ¨ThreadDemoç±»ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªè·å–è¦éš”ç¦»è®¿é—®çš„æ•°æ®çš„æ–¹æ³•getXxx()ï¼Œåœ¨æ–¹æ³•ä¸­åˆ¤æ–­ï¼Œè‹¥ThreadLocalå¯¹è±¡ä¸ºnullæ—¶å€™ï¼Œåº”è¯¥new()ä¸€ä¸ªéš”ç¦»è®¿é—®ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶å¼ºåˆ¶è½¬æ¢ä¸ºè¦åº”ç”¨çš„ç±»å‹ã€‚</li> <li>åœ¨ThreadDemoç±»çš„run()æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨getXxx()æ–¹æ³•è·å–è¦æ“ä½œçš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªæ•°æ®å¯¹è±¡ï¼Œåœ¨ä»»ä½•æ—¶åˆ»éƒ½æ“ä½œçš„æ˜¯è¿™ä¸ªå¯¹è±¡ã€‚</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalTest</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">StudentThreadLocal</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Student</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> currentThreadName <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>currentThreadName <span class="token operator">+</span> <span class="token string">&quot; is running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>currentThreadName <span class="token operator">+</span> <span class="token string">&quot; is set age: &quot;</span>  <span class="token operator">+</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Student</span> <span class="token class-name">Student</span> <span class="token operator">=</span> <span class="token function">getStudentt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½ç‹¬ç«‹çš„newä¸€ä¸ªStudenttå¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„çš„Studenttå¯¹è±¡éƒ½å¯ä»¥è®¾ç½®ä¸åŒçš„å€¼</span>
        <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>currentThreadName <span class="token operator">+</span> <span class="token string">&quot; is first get age: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span> currentThreadName <span class="token operator">+</span> <span class="token string">&quot; is second get age: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Student</span><span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Student</span> <span class="token function">getStudentt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> <span class="token class-name">Student</span> <span class="token operator">=</span> <span class="token class-name">StudentThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token class-name">Student</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Student</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StudentThreadLocal</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Student</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Student</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocalTest</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span><span class="token string">&quot;Thread A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span><span class="token string">&quot;Thread B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="java-å¼€å‘æ‰‹å†Œä¸­æ¨èçš„-threadlocal"><a href="#java-å¼€å‘æ‰‹å†Œä¸­æ¨èçš„-threadlocal" class="header-anchor">#</a> java å¼€å‘æ‰‹å†Œä¸­æ¨èçš„ ThreadLocal</h3> <p>çœ‹çœ‹é˜¿é‡Œå·´å·´ java å¼€å‘æ‰‹å†Œä¸­æ¨èçš„ ThreadLocal çš„ç”¨æ³•:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">DateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DateUtils</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DateFormat</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DateFormat</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">DateFormat</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ç„¶åæˆ‘ä»¬å†è¦ç”¨åˆ° DateFormat å¯¹è±¡çš„åœ°æ–¹ï¼Œè¿™æ ·è°ƒç”¨ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DateUtils.df.get().format(new Date());
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="header-anchor">#</a> å‚è€ƒæ–‡ç« </h2> <ul><li>https://blog.csdn.net/vking_wang/article/details/14225379</li> <li>https://mp.weixin.qq.com/s/mo3-y-45_ao54b5T7ez7iA</li> <li>https://www.xttblog.com/?p=3087</li> <li>https://blog.csdn.net/whut2010hj/article/details/81413887</li> <li>https://segmentfault.com/a/1190000018399795</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2022/1/16 ä¸‹åˆ5:24:46</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/md/java/learn/å…³é”®å­—-final.html" class="prev">
        å…³é”®å­—-final
      </a></span> <span class="next"><a href="/md/java/learn/Springç¬”è®°.html">
        Spring
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.7437448f.js" defer></script><script src="/assets/js/5.ea3a467f.js" defer></script><script src="/assets/js/32.54420f34.js" defer></script>
  </body>
</html>
